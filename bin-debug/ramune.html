<!--

Copyright ¬© 2008 The Regents of the University of California
All Rights Reserved

Created by Hector Guillermo Parra, hector@hectorparra.com
California Institute for Telecommunications and Information Technology
University of California, Irvine

-->
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Ramune Prototype</title>
		<link rel="stylesheet" type="text/css" href="stylesheets/ramune.css" />
		<link rel="stylesheet" type="text/css" href="stylesheets/ramune.login.css" />
		<link rel="stylesheet" type="text/css" href="stylesheets/jquery.jgrowl.css" />
		<script type="text/javascript" src="javascripts/FABridge.js" ></script>
		<script type="text/javascript" src="javascripts/jquery-1.3.2.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.swfobject.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.dom-builder.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.jgrowl.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.corners.js" ></script>
		<script type="text/javascript" src="javascripts/jRamune.js" ></script>
		<script type="text/javascript" src="javascripts/ramune.js" ></script>
		<style>
		</style>
		<script type="text/javascript">

		var ramune;
		var username;

		var friends; /* RemoteSharedObject */
		var me; /* RemoteShared Object Data[username] */
		
		function onFABridgeInitialized() {
			trace("FABridge Initialized");
			ramune = FABridge.Ramune.root();
			fms = ramune.newNetConnection();
			fms.connect("rtmp://hbox.calit2.uci.edu/RamuneTest", username, "0");
			fms.addEventListener("netStatus", function(event) {
				trace(event.getInfo().code);
				switch (event.getInfo().code) {
					case "NetConnection.Connect.Success" :
						trace("Connected to FMS: " + fms.getUri());
						
						friends = ramune.getRemoteSharedObject("clients", fms.getUri());
						friends.addEventListener("sync", function(sync_event) {
							trace("Friends Synced");

							me = friends.getData()[username];
							
							// TODO: Make it's own function
							$("#friends").html("");
							for (i in friends.getData()) {
								// TODO: [HACK] if they don't have an id they are not available
								// TODO: [HACK] Don't include yourself
								if (i != me.username && friends.getData()[i].nearID != "0") {
									$$('div.friend',
										$$('div.friend_photo', $$('img', {src: "images/blank_face.gif", id: i})),
										$$('div.friend_name', i),
										{
											id: friends.getData()[i].nearID
											 }
									).appendTo('#friends').bind("click", function() {
										ramune.placeCall('test', this.id);
									});
								}
							}
							
						});
						friends.connect(fms);

						jRamune.connect();

						break;
				}
			});
		}
		
		// TODO: Integrate into frescolita
		$(document).ready(function() {
		
			// Hide Ramune States
			for (i in jRamune.states)
				$('#' + jRamune.states[i]).hide();

			initializeLogin();
		});
		
		
		
		function loggingin() {
			username = $('input#login').val().split(' ').join('');

			// TODO: Username Validation
			
			if (username != null) {
				$("#Login").hide();
				initializeRamune();
			}
			else {
				// TODO: Error
			}
			
		}
		
		/* CONTROLLER */
		function initializeRamune() {
		
			/* STATE_CHANGED */
			$("#ramunex").bind(jRamune.events.STATE_CHANGED, function(e) {
				trace(e.state);
				
				for (i in jRamune.states)
					$('#' + jRamune.states[i]).hide();
				$("#" + e.state).show();
				
				switch(e.state) {
					case jRamune.states.CALL_READY:
						break;
				}
			});
			
			/* RESIZE */
			$("#ramunex").bind(jRamune.events.RESIZE, function(e) {
				// FIXME: we never want people to access div#ramune directly
				$("#ramune").css("width", e.width);
				$("#ramune").css("height", e.height);
			});
			
			/* NETCONNECTION_SUCCESSFUL */
			$("#ramunex").bind(jRamune.events.NETCONNECTION_SUCCESSFUL, function(e) {
				trace(e.farID);
				// TODO: abstract
				me.nearID = e.farID;
				friends.setProperty(username, me);
				friends.setDirty(username);
				
			});
			
			/* FABridge */
			FABridge.addInitializationCallback("Ramune", onFABridgeInitialized);
			
			/* Initialize */
			jRamune.initialize("#ramunex", "", { bridgeName: "Ramune" });
		}
		
		/* VIEW */
		function initializeLogin() {
	
			// TODO: Should be part of settings and should be global var
			font_size = 38; // TODO: descriptive name
			input_length = 500; // TODO: descriptive name
			login_box_corner_radius = 20;
			login_box_opacity = 0.4;
		    
			/* scale input boxes */
			$('label#for_login').css('font-size', font_size);
			$('input#login').css('font-size', font_size);
			$('input#login').css('height', font_size + 10); // TODO: Resolve magic number
			$('input#login').css('width', input_length);
		
			/* login button */
			$('#login_button').css('font-size', font_size);
		
			/* dimensions of box with content already inside */
			//login_box_width = screen_width * 0.5;
			//login_box_height = screen_height * 0.20;
			login_box_width = $('div#login_box').width();
			login_box_height = $('div#login_box').height();
		
			/* scale, position and modify LoginBox */
			//$('div#login_box').css('width', login_box_width);
			//$('div#login_box').css('height', login_box_height);
			$('div#login_box').css('margin-top', -login_box_height / 2);
			$('div#login_box').css('margin-left', -login_box_width / 2);
			$('div#login_box').corners(login_box_corner_radius + "px");
			$('div#login_box').css('opacity', login_box_opacity);

		}
		
		</script>
	</head>

	<body scroll="no"><!-- TODO: Research this tag option. Valid HTML? -->
		<div id="ramunex">
		</div>
		
		<div id="Login">
			<div id="login_box">
				<div id="items">
					<fieldset>
						<dl>
							<dt><label id="for_login" for="login">Name</label></dt>
							<dd><input id="login" name="login" type="text" /></dd>
							<dt><a id="login_button" href="#" onclick="loggingin();">Login</a></dt>
						</dl>
					</fieldset>
				</div>
			</div>
		</div>
		
		<div id="RamuneCallNotReady">
			<h1>Please Wait...</h1>
		</div>

		<div id="RamuneCallReady">
			<h1>Friends</h1>
			<div id="friends">
			</div>
		</div>

		<div id="RamuneCallCalling">
			Calling...
			<a href="#" onclick="jRamune.endCall()">Hang Up</a>
		</div>

		<div id="RamuneCallRinging">
			<a href="#" onclick="jRamune.acceptCall()">Pick Up</a>
			<a href="#" onclick="jRamune.ignoreCall()">Ignore</a>
		</div>

		<div id="RamuneCallEstablished"><!-- Do not use! Use Ramunex instead -->
			<a href="#" onclick="jRamune.endCall()">Hang Up</a>
		</div>

		<div id="RamuneCallFailed">
		</div>
		
	</body>
</html>
