<!--

Copyright Â© 2008 The Regents of the University of California
All Rights Reserved

Created by Hector Guillermo Parra, hector@hectorparra.com
California Institute for Telecommunications and Information Technology
University of California, Irvine

-->
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Ramune Prototype</title>
		<link rel="stylesheet" type="text/css" href="stylesheets/ramune.css" />
		<link rel="stylesheet" type="text/css" href="stylesheets/ramune.login.css" />
		<link rel="stylesheet" type="text/css" href="stylesheets/jquery.jgrowl.css" />
		<script type="text/javascript" src="javascripts/FABridge.js" ></script>
		<script type="text/javascript" src="javascripts/jquery-1.3.2.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.swfobject.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.dom-builder.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.jgrowl.js" ></script>
		<script type="text/javascript" src="javascripts/jquery.corners.js" ></script>
		<script type="text/javascript" src="javascripts/jRamune.js" ></script>
		<script type="text/javascript" src="javascripts/ramune.js" ></script>
		<style>
		</style>
		<script type="text/javascript">
		var ramune;
		var username;
		
		function placeCall() {
			key = prompt("FarID?", "");
			if(key) 
				ramune.placeCall('test', key);
		}
		
		function connectToFMS(my_id) {
			fms = ramune.newNetConnection();
			fms.connect("rtmp://hbox.calit2.uci.edu/RamuneTest", username, my_id);
			fms.addEventListener("netStatus", function(event) {
				switch (event.getInfo().code) {
					case "NetConnection.Connect.Success" :
						//debug("Connected to FMS: " + fms.getUri());
						
						buddies = ramune.getRemoteSharedObject("clients", fms.getUri());

						buddies.addEventListener("sync", function(sync_event) {
						$("#buddies").html("");
							for (i in buddies.getData()) {
								$$('div.friend',
									$$('div.friend_photo', $$('img', {src: "images/blank_face.gif", id: i})),
									$$('div.friend_name', i),
									{
										id: buddies.getData()[i].nearID,
										href: "#"
										 }
								).appendTo('#buddies').bind("click", function() {
									ramune.placeCall('test', this.id);
								});
							}
						});
						
						buddies.connect(fms);
						
						break;
				}
			});
		}
		
		// TODO: Integrate into frescolita
		$(document).ready(function() {
			
			initializeLogin();
			
			// hide all states
			for (i in jRamune.states)
				$('#' + jRamune.states[i]).hide();

			
			FABridge.addInitializationCallback("Ramune", onInitialized);
			//
		});
		
		function onInitialized() {
			ramune = FABridge.Ramune.root();
			
		}
		
		function loggingin() {
			username = $('input#login').val();
			
			$('#RamuneLogin').hide();
			
			jRamune.initialize("#ramunex", "", { bridgeName: "Ramune" });

			$("#ramunex").bind(jRamune.events.NETCONNECTION_SUCCESSFUL, function(e) {
				trace(e.farID);
				connectToFMS(e.farID);
			});
			
			/* STATE CHANGE */
			$("#ramunex").bind(jRamune.events.STATE_CHANGED, function(e) {
				trace(e.state);
				
				for (i in jRamune.states)
					$('#' + jRamune.states[i]).hide();
				$("#" + e.state).show();
				
				switch(e.state) {
					case jRamune.states.CALL_READY:
						ramune.setSize(0, 0);
						break;
				}
			});
			
			$("#ramunex").bind(jRamune.events.RESIZE, function(e) {
				// FIXME: we never want people to access div#ramune directly
				$("#ramune").css("width", e.width);
				$("#ramune").css("height", e.height);
			});
		}
		
		function initializeLogin() {
	
			// TODO: Should be part of settings and should be global var
			font_size = 38; // TODO: descriptive name
			input_length = 500; // TODO: descriptive name
			login_box_corner_radius = 20;
			login_box_opacity = 0.4;
		    
			/* scale input boxes */
			$('label#for_login').css('font-size', font_size);
			$('input#login').css('font-size', font_size);
			$('input#login').css('height', font_size + 10); // TODO: Resolve magic number
			$('input#login').css('width', input_length);
		
			/* login button */
			$('#login_button').css('font-size', font_size);
		
			/* dimensions of box with content already inside */
			//login_box_width = screen_width * 0.5;
			//login_box_height = screen_height * 0.20;
			login_box_width = $('div#login_box').width();
			login_box_height = $('div#login_box').height();
		
			/* scale, position and modify LoginBox */
			//$('div#login_box').css('width', login_box_width);
			//$('div#login_box').css('height', login_box_height);
			$('div#login_box').css('margin-top', -login_box_height / 2);
			$('div#login_box').css('margin-left', -login_box_width / 2);
			$('div#login_box').corners(login_box_corner_radius + "px");
			$('div#login_box').css('opacity', login_box_opacity);

		}
		
		</script>
	</head>

	<body scroll="no"><!-- TODO: Research this tag option. Valid HTML? -->
		<div id="ramunex"></div>
		
		<!-- STATES -->
		<div id="RamuneLogin">
			<div id="login_box">
				<div id="items">
					<fieldset>
						<dl>
							<dt><label id="for_login" for="login">Name</label></dt>
							<dd><input id="login" name="login" type="text" /></dd>
							<dt><a id="login_button" href="#" onclick="loggingin();">Login</a></dt>
						</dl>
					</fieldset>
				</div>
			</div>
		</div>
		<div id="RamuneCallNotReady">
			Please Wait...
		</div>
		<div id="RamuneCallReady">
			<div id="buddies">
			</div>
		</div>
		<div id="RamuneCallCalling">
			Calling...
		</div>
		<div id="RamuneCallRinging">
			<a href="#" onclick="jRamune.acceptCall()">Accept Call?</a>
			<a href="#" onclick="jRamune.ignoreCall()">Ignore Call?</a>
		</div>
		<div id="RamuneCallEstablished">
			<a href="#" onclick="jRamune.endCall()">Hang Up</a>
		</div>
		<div id="RamuneCallFailed">
		</div>
		
	</body>
</html>
